<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width,initial-scale=1" name="viewport"/>
    <title>Toss ê²°ì œ í…ŒìŠ¤íŠ¸</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Pretendard", "Noto Sans KR", sans-serif;
            background: #f7f7f7;
            min-height: 100vh;
            padding: 0;
        }
        .header {
            background: white;
            border-bottom: 1px solid #e5e5e5;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-title { font-size: 18px; font-weight: 600; color: #111; }

        .container { max-width: 640px; margin: 0 auto; padding: 20px; }
        .section {
            background: white;
            border-radius: 8px;
            padding: 24px 20px;
            margin-bottom: 12px;
        }
        .section-title { font-size: 16px; font-weight: 600; color: #111; margin-bottom: 20px; }

        .order-info {
            display: flex;
            align-items: center;
            gap: 16px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .product-image {
            width: 80px; height: 80px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px;
            flex-shrink: 0;
        }
        .product-info { flex: 1; }
        .product-name { font-size: 15px; font-weight: 500; color: #111; margin-bottom: 6px; }
        .product-price { font-size: 18px; font-weight: 700; color: #111; }

        .form-group { margin-bottom: 20px; }
        .form-group:last-child { margin-bottom: 0; }
        label { display: block; font-size: 14px; font-weight: 600; color: #333; margin-bottom: 8px; }
        input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
            transition: all 0.2s ease;
            outline: none;
            background: #fafafa;
        }
        input:focus { border-color: #4285f4; background: white; }
        input::placeholder { color: #999; }

        .price-summary { padding-top: 20px; }
        .price-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px;
            font-size: 15px;
            color: #666;
        }
        .price-row.total {
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
            margin-top: 12px;
            margin-bottom: 0;
        }
        .price-row.total .label { font-size: 16px; font-weight: 600; color: #111; }
        .price-row.total .value { font-size: 22px; font-weight: 700; color: #4285f4; }

        .btn-pay {
            width: 100%;
            padding: 18px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 12px;
        }
        .btn-pay:hover { background: #3367d6; }
        .btn-pay:active { transform: scale(0.98); }
        .btn-pay:disabled { background: #9dbcf7; cursor: not-allowed; }

        .log-section { margin-top: 12px; }
        .log-container {
            padding: 16px;
            background: #f5f5f5;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            max-height: 260px;
            overflow-y: auto;
        }
        .log-title { font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; }
        #log {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.6;
        }
        .info-text { font-size: 13px; color: #999; margin-top: 8px; line-height: 1.5; }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: #e3f2fd;
            color: #1976d2;
            font-size: 12px;
            font-weight: 600;
            border-radius: 3px;
            margin-bottom: 12px;
        }
        .hint {
            font-size: 12px;
            color: #666;
            background: #fff7e6;
            border: 1px solid #ffe0a3;
            padding: 10px 12px;
            border-radius: 6px;
            line-height: 1.5;
        }

        @media (max-width: 640px) {
            .container { padding: 12px; }
            .section { padding: 20px 16px; }
        }
    </style>
</head>

<body>
<div class="header">
    <div class="header-title">ì£¼ë¬¸/ê²°ì œ</div>
</div>

<div class="container">
    <div class="section">
        <div class="section-title">ì£¼ë¬¸ìƒí’ˆ</div>
        <div class="order-info">
            <div class="product-image">ğŸ“¦</div>
            <div class="product-info">
                <div class="product-name" id="productName">í…ŒìŠ¤íŠ¸ ìƒí’ˆ</div>
                <div class="product-price" id="displayAmount">-</div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">ì£¼ë¬¸ì •ë³´</div>
        <div class="badge">í…ŒìŠ¤íŠ¸ ê²°ì œ</div>

        <div class="form-group">
            <label for="orderId">ì£¼ë¬¸ë²ˆí˜¸</label>
            <input id="orderId" placeholder="ì˜ˆ: 550e8400-e29b-41d4-a716-446655440000"/>
            <div class="info-text">UUID í˜•ì‹ì˜ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
        </div>

        <div class="form-group">
            <label for="amount">ê²°ì œê¸ˆì•¡</label>
            <input id="amount" min="1" placeholder="ì˜ˆ: 15000" type="number"/>
            <div class="info-text">1ì› ì´ìƒ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
        </div>

        <div class="hint" style="margin-top: 12px;">
            âœ… íŒ: URLì— ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¥¼ ë¶™ì´ë©´ ìë™ ì…ë ¥ë¼ìš”.<br/>
            ì˜ˆ) <b>/toss-test.html?orderId=UUID&amount=15000&auto=1</b><br/>
            auto=1ì´ë©´ ìë™ìœ¼ë¡œ ê²°ì œ ë²„íŠ¼ì„ ëˆŒëŸ¬ìš”(í…ŒìŠ¤íŠ¸ìš©).
        </div>
    </div>

    <div class="section">
        <div class="section-title">ìµœì¢… ê²°ì œê¸ˆì•¡</div>
        <div class="price-summary">
            <div class="price-row">
                <span class="label">ìƒí’ˆê¸ˆì•¡</span>
                <span class="value" id="itemPrice">-</span>
            </div>
            <div class="price-row">
                <span class="label">ë°°ì†¡ë¹„</span>
                <span class="value">ë¬´ë£Œ</span>
            </div>
            <div class="price-row total">
                <span class="label">ìµœì¢… ê²°ì œê¸ˆì•¡</span>
                <span class="value" id="finalPrice">0ì›</span>
            </div>
        </div>
    </div>

    <button class="btn-pay" id="btn">ê²°ì œí•˜ê¸°</button>

    <div class="log-section" id="logContainer" style="display:none;">
        <div class="log-container">
            <div class="log-title">ì²˜ë¦¬ ë¡œê·¸</div>
            <pre id="log"></pre>
        </div>
    </div>
</div>

<script src="https://js.tosspayments.com/v2/standard"></script>
<script>
    // ===== DOM =====
    const $log = document.getElementById("log");
    const $logContainer = document.getElementById("logContainer");
    const $btn = document.getElementById("btn");

    const $orderId = document.getElementById("orderId");
    const $amount = document.getElementById("amount");
    const $displayAmount = document.getElementById("displayAmount");
    const $itemPrice = document.getElementById("itemPrice");
    const $finalPrice = document.getElementById("finalPrice");

    // ===== Utils =====
    const formatPrice = (price) => price.toLocaleString("ko-KR") + "ì›";

    const showAmount = (value) => {
        if (value > 0) {
            const formatted = formatPrice(value);
            $displayAmount.textContent = formatted;
            $itemPrice.textContent = formatted;
            $finalPrice.textContent = formatted;
        } else {
            $displayAmount.textContent = "-";
            $itemPrice.textContent = "-";
            $finalPrice.textContent = "0ì›";
        }
    };

    const log = (...args) => {
        $logContainer.style.display = "block";
        $log.textContent += args.join(" ") + "\n";
        $logContainer.scrollTop = $logContainer.scrollHeight;
    };

    const setBusy = (busy) => {
        $btn.disabled = busy;
        $btn.textContent = busy ? "ì²˜ë¦¬ ì¤‘..." : "ê²°ì œí•˜ê¸°";
    };

    const safeText = async (res) => {
        try { return await res.text(); } catch { return ""; }
    };

    const isUuid = (s) => {
        return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(s);
    };

    // ===== Live amount rendering =====
    $amount.addEventListener("input", (e) => {
        const value = Number(e.target.value);
        showAmount(value);
    });

    // ===== Query param preset =====
    // /toss-test.html?orderId=...&amount=...&auto=1
    const params = new URLSearchParams(location.search);
    const presetOrderId = params.get("orderId");
    const presetAmount = params.get("amount");
    const auto = params.get("auto");

    if (presetOrderId) $orderId.value = presetOrderId;
    if (presetAmount) {
        $amount.value = presetAmount;
        showAmount(Number(presetAmount));
    }

    // ===== Main =====
    $btn.addEventListener("click", async () => {
        $log.textContent = "";
        $logContainer.style.display = "none";

        const orderId = $orderId.value.trim();
        const amount = Number($amount.value);

        if (!orderId) { log("âŒ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"); return; }
        if (!isUuid(orderId)) { log("âŒ ì£¼ë¬¸ë²ˆí˜¸(UUID) í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤"); return; }
        if (!amount || amount < 1) { log("âŒ ê²°ì œê¸ˆì•¡ì„ 1ì› ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”"); return; }

        setBusy(true);

        try {
            log("â³ [1] /api/v1/payments/ready í˜¸ì¶œ ì¤‘...");

            // same-origin í˜¸ì¶œ: í˜ì´ì§€ê°€ ë°˜ë“œì‹œ ì„œë²„(8080)ì—ì„œ ì„œë¹™ë˜ì–´ì•¼ í•¨
            const readyRes = await fetch("/api/v1/payments/ready", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ orderId, amount })
            });

            if (!readyRes.ok) {
                const err = await safeText(readyRes);
                log("âŒ READY ì‹¤íŒ¨:", readyRes.status, err);
                return;
            }

            const ready = await readyRes.json();
            log("âœ… [2] READY ì‘ë‹µ:\n" + JSON.stringify(ready, null, 2));

            // í•„ìˆ˜ í•„ë“œ ê²€ì¦
            const required = ["clientKey", "orderId", "amount", "orderName", "customerName", "successUrl", "failUrl"];
            for (const k of required) {
                if (ready[k] === undefined || ready[k] === null || ready[k] === "") {
                    log(`âŒ READY ì‘ë‹µì— ${k} ê°€ ì—†ìŠµë‹ˆë‹¤.`);
                    return;
                }
            }

            // Toss ê²°ì œì°½ í˜¸ì¶œ
            log("ğŸš€ [3] ê²°ì œì°½ ìš”ì²­ ì‹œì‘...");

            const tossPayments = TossPayments(ready.clientKey);
            const payment = tossPayments.payment({ customerKey: "test-customer-key" });

            await payment.requestPayment({
                method: "CARD",
                amount: { currency: "KRW", value: Number(ready.amount) },
                orderId: ready.orderId,
                orderName: ready.orderName,
                customerName: ready.customerName,
                successUrl: ready.successUrl,
                failUrl: ready.failUrl,
            });

            // requestPayment í˜¸ì¶œ í›„ì—ëŠ” ë³´í†µ tossê°€ ë¦¬ë‹¤ì´ë ‰íŠ¸/íŒì—…ì„ ì§„í–‰í•˜ë¯€ë¡œ ì—¬ê¸°ê¹Œì§€ ì˜¤ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
            log("â„¹ï¸ ê²°ì œì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ê²°ì œ ì™„ë£Œ í›„ successUrlë¡œ ì´ë™í•©ë‹ˆë‹¤.");
        } catch (e) {
            log("âŒ ì˜ˆì™¸ ë°œìƒ:", e?.message || String(e));
            console.error(e);
        } finally {
            setBusy(false);
        }
    });

    // auto=1ì´ë©´ ìë™ ì‹¤í–‰
    if (auto === "1") {
        setTimeout(() => $btn.click(), 300);
    }
</script>
</body>
</html>
